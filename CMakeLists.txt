cmake_minimum_required(VERSION 2.8)

string(ASCII 27 ESCAPE)
set(PI1000 3142)
set(PI500 1571)
set(_PI500 -1571)
set(_2PI1000 6283)

set(SX 50)
set(SY 20)
set(RX 2)
set(RY 1)

set(HLen 10)
set(MLen 14)
set(SLen 14)

function (clrscr)
    file(WRITE /dev/stdout "${ESCAPE}[2J")
endfunction(clrscr)

function(textXY X Y MSG)
    file(WRITE /dev/stdout "${ESCAPE}[${Y};${X}H${MSG}")
endfunction(textXY)

macro(max a b m)
	if(${a} LESS ${${b}})
		set(${m} ${${b}})
	else(${a} LESS ${${b}})
		set(${m} ${${a}})
	endif(${a} LESS ${${b}})
endmacro(max)

macro(min a b m)
	if(${a} LESS ${${b}})
		set(${m} ${${a}})
	else(${a} LESS ${${b}})
		set(${m} ${${b}})
	endif(${a} LESS ${${b}})
endmacro(min)

macro(abs a res)
	if(${a} LESS 0)
		string(LENGTH ${a} len)
		math(EXPR l1 "${len} - 1")
		string(SUBSTRING ${a} 1 ${l1} ${res})
	else(${a} LESS 0)
		set(${res} ${a})
	endif(${a} LESS 0)
endmacro(abs)

function(line x1 y1 x2 y2 chr)
	math(EXPR Dx "${x2} - ${x1}")
	abs(${Dx} aDx)
	math(EXPR Dy "${y2} - ${y1}")
	abs(${Dy} aDy)
	max(aDx aDy Dmax)
	set(i 0)
	while(i LESS ${Dmax})
		math(EXPR cx "${x1} + ${i} * (0${Dx} * 100 / ${Dmax}) / 100")
		math(EXPR cy "${y1} + ${i} * (0${Dy} * 100 / ${Dmax}) / 100")
		textXY(${cx} ${cy} ${chr})
		math(EXPR i "${i} + 1")
	endwhile(i LESS ${Dmax})
endfunction(line)

# translation from degrees to radian*1000:
macro(m_rad1000_4sin x res)
	math(EXPR rad1000 "(0${x}) * ${PI1000} / 180")
	if(rad1000 GREATER ${PI1000})
		math(EXPR rad1000_ "${PI1000} - ${rad1000}")
	else(rad1000 GREATER ${PI1000})
		set(rad1000_ ${rad1000})
	endif(rad1000 GREATER ${PI1000})
	
	if(rad1000_ GREATER ${PI500})
		math(EXPR rad1000__ "${PI1000} - ${rad1000_}")
	else(rad1000_ GREATER ${PI500})
		if(rad1000_ LESS ${_PI500})
			abs(${rad1000_} abs_rad1000_)
			math(EXPR rad1000__ "${abs_rad1000_} - ${PI1000}")
		else(rad1000_ LESS ${_PI500})
			set(rad1000__ ${rad1000_})
		endif(rad1000_ LESS ${_PI500})
	endif(rad1000_ GREATER ${PI500})
	
	set(${res} ${rad1000__})
endmacro(m_rad1000_4sin)

macro(m_rad1000_4cos x res)
	math(EXPR rad1000 "(0${x}) * ${PI1000} / 180")
	if(rad1000 GREATER ${PI1000})
		math(EXPR rad1000_ "${rad1000} - ${_2PI1000}")
	else(rad1000 GREATER ${PI1000})
		set(rad1000_ ${rad1000})
	endif(rad1000 GREATER ${PI1000})
	
	set(${res} ${rad1000_})
endmacro(m_rad1000_4cos)

macro(sin1000 x res)
	m_rad1000_4sin(${x} r1000)
	math(EXPR ${res} "0${r1000} - (0${r1000}) * (0${r1000}) / 1000 * (0${r1000}) / 1000 / 6 + (0${r1000}) * (0${r1000}) / 1000 * (0${r1000}) / 1000 * (0${r1000}) / 1000 * (0${r1000}) / 1000 / 120")
endmacro(sin1000)

macro(cos1000 x res)
	m_rad1000_4cos(${x} r1000)
	unset(sign)
	if(r1000 GREATER ${PI500})
		math(EXPR r1000_ "${PI1000} - ${r1000}")
		set(r1000 ${r1000_})
		set(sign "0-")
	endif(r1000 GREATER ${PI500})
	
	if(r1000 LESS ${_PI500})
		math(EXPR r1000_ "${PI1000} + (0${r1000})")
		set(r1000 ${r1000_})
		set(sign "0-")
	endif(r1000 LESS ${_PI500})
	
	math(EXPR ${res} "${sign}(1000 - (0${r1000}) * (0${r1000}) / 1000 / 2 + (0${r1000}) * (0${r1000}) / 1000 * (0${r1000}) / 1000 * (0${r1000}) / 1000 / 24 - (0${r1000}) * (0${r1000}) / 1000 * (0${r1000}) / 1000 * (0${r1000}) / 1000 * (0${r1000}) / 1000 * (0${r1000}) / 1000 / 720)")
endmacro(cos1000)

clrscr()
set(X 0)
set(Y 0)

foreach(i RANGE 1 12 1)
	math(EXPR alfa "${i}*30 - 90")
	sin1000(${alfa} sin)
	cos1000(${alfa} cos)
	math(EXPR X "${SX} + (${MLen}+1) * ${RX} * (0${cos}) / 1000")
	math(EXPR Y "${SY} + (${MLen}+1) * ${RY} * (0${sin}) / 1000")
	textXY(${X} ${Y} ${i})
endforeach(i)

# main loop
set(oldtime 000000)
while(true)
	execute_process(COMMAND "date" "+%H%M%S" OUTPUT_VARIABLE time)
	if(NOT(oldtime EQUAL time))
		string(SUBSTRING ${time} 0 2 hours)
		string(SUBSTRING ${time} 2 2 mins)
		string(SUBSTRING ${time} 4 2 secs)
		
		string(SUBSTRING ${oldtime} 0 2 ohours)
		string(SUBSTRING ${oldtime} 2 2 omins)
		string(SUBSTRING ${oldtime} 4 2 osecs)
	
		math(EXPR alfa "${osecs}*6 - 90")
		sin1000(${alfa} sin)
		cos1000(${alfa} cos)
		math(EXPR oX "${SX} + ${SLen} * ${RX} * (0${cos}) / 1000")
		math(EXPR oY "${SY} + ${SLen} * ${RY} * (0${sin}) / 1000")
		
		math(EXPR alfa "${secs}*6 - 90")
		sin1000(${alfa} sin)
		cos1000(${alfa} cos)
		math(EXPR X "${SX} + ${SLen} * ${RX} * (0${cos}) / 1000")
		math(EXPR Y "${SY} + ${SLen} * ${RY} * (0${sin}) / 1000")
		
		line(${SX} ${SY} ${oX} ${oY} " ")
		line(${SX} ${SY} ${X} ${Y} "*")
		
		math(EXPR alfa "${omins}*6 - 90")
		sin1000(${alfa} sin)
		cos1000(${alfa} cos)
		math(EXPR oX "${SX} + ${MLen} * ${RX} * (0${cos}) / 1000")
		math(EXPR oY "${SY} + ${MLen} * ${RY} * (0${sin}) / 1000")
		
		math(EXPR alfa "${mins}*6 - 90")
		sin1000(${alfa} sin)
		cos1000(${alfa} cos)
		math(EXPR X "${SX} + ${MLen} * ${RX} * (0${cos}) / 1000")
		math(EXPR Y "${SY} + ${MLen} * ${RY} * (0${sin}) / 1000")
		
		line(${SX} ${SY} ${oX} ${oY} " ")
		line(${SX} ${SY} ${X} ${Y} "*")
		
		math(EXPR alfa "(${ohours} % 12)*30 - 90")
		sin1000(${alfa} sin)
		cos1000(${alfa} cos)
		math(EXPR oX "${SX} + ${HLen} * ${RX} * (0${cos}) / 1000")
		math(EXPR oY "${SY} + ${HLen} * ${RY} * (0${sin}) / 1000")
		
		math(EXPR alfa "(${hours} % 12)*30 - 90")
		sin1000(${alfa} sin)
		cos1000(${alfa} cos)
		math(EXPR X "${SX} + ${HLen} * ${RX} * (0${cos}) / 1000")
		math(EXPR Y "${SY} + ${HLen} * ${RY} * (0${sin}) / 1000")
		
		line(${SX} ${SY} ${oX} ${oY} " ")
		line(${SX} ${SY} ${X} ${Y} "*")
		
		set(oldtime ${time})
	endif(NOT(oldtime EQUAL time))
endwhile(true)
